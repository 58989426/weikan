<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>title</title>
      <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../../css/common.css"/>
      <link rel="stylesheet" type="text/css" href="../../../css/aui.css"/>
      <style>
        body{background: #fff;}
        body {
            background: #FFFfee;
        }
        #metainfo {position:fixed;bottom:0;left:0;right:0;clear:both;height: 20px}
        #metainfo > span{
          display: inline-block;
          width:48%;
          overflow:hidden;
          white-space:nowrap;
          font-size:14px;
          color:#333;
          text-overflow: ellipsis;
        }
        #metainfo .z{float:left;margin-left: 3px;}
        #metainfo .y {float:right;text-align: right;margin-right: 3px;}
      </style>
  </head>
  <body>
    <div id="read">
      <div id="metainfo">
        <span id="bookname" class="z">书名</span>
        <span id="subject" class="y">章节名</span>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="../../../script/api.js"></script>
  <script type="text/javascript" src="../../../script/common.js"></script>
  <script type="text/javascript" src="../../../script/vue.min.js"></script>
  <script type="text/javascript" src="../../../script/aui-toast.js"></script>
  <script type="text/javascript">
      var toast = new auiToast({});
      var indexSetting; //阅读页设置

      var vm=new Vue({
          el:"#read",
          data:{
            bookinfo:{},
            chapterInfo:{},
            filepath:null,
          },
          mounted: function () {
                  apiready = function(){
                    api.setFullScreen({
                        fullScreen: true
                    });
                    vm.bookinfo=api.pageParam;
                    // $api.rmStorage('history');
                    api.addEventListener({
                        name: 'keyback'
                    }, function(ret, err) {
                        if (ret) {
                        	api.setFullScreen({
                                fullScreen: false
                            });
                            var thebook = $api.getStorage('thebook');
                            ajaxhistory(thebook.chapter_id, thebook.chapter_name,thebook.price);
                            back();
                        }
                    });

                    //判断localstorage里是否有阅读页设置  若没有则设置初始值
                    if($api.getStorage('indexSetting') == undefined){
                      indexSetting = {};
                      indexSetting.fontsize = 16;
                      indexSetting.bg = "#f7e3c2";
                      indexSetting.color = "#333";
                      $api.setStorage('yejianmoshi',0);
                      $api.setStorage('indexSetting',indexSetting);
                    }else{
                      indexSetting = $api.getStorage('indexSetting');
                      indexSetting.bg = ($api.getStorage('yejianmoshi') > 0) ? '#212121' : indexSetting.bg;
                      indexSetting.color = ($api.getStorage('yejianmoshi') > 0) ? '#eee' : indexSetting.color ;
                    }
                    indexSetting.bookReader = api.require('bookReader');
                    indexSetting.fs = api.require('fs');
                    indexSetting.book_id = vm.bookinfo.id;
                    indexSetting.bookinfo = vm.bookinfo;

                    //初始获取章节信息
                    vm.filepath = 'fs://' + indexSetting.bookinfo.id + '_' + indexSetting.bookinfo.read_chapter_id + '.txt';
                    getData(indexSetting.bookinfo.id,indexSetting.bookinfo.read_chapter_id,0);
                  };
          },
          methods:{

          },
      });


    //请求接口获取数据
    function getData(bookid,chapterid,progress){
        toast.loading({
            title:"loading...",
            duration:2000
        })
        api.ajax({
             url: "https://www.luluxs8.com/novel/v2/Chapter/ChapterInfo.php?bookId="+bookid+"&chapterId="+chapterid,
             method: 'get',
         }, function(ret, err) {
              if(ret.code==200){
                //如果请求成功 进行初始化判断操作
                initload(ret.data.content,progress);
                $api.setStorage('thebook',ret.data);
                var thebook = $api.getStorage('thebook');
                ajaxhistory(thebook.chapter_id, thebook.chapter_name,thebook.price);
                // $api.text($api.byId("bookname"), indexSetting.bookinfo.name);
                // $api.text($api.byId("subject"), ret.data.chapter_name);
              }else {
                alert("章节信息有误！")
              }
         }
       );
    }
    // 判断本章章节文件是否存在
    function initload(content,progress) {
        var filepath=vm.filepath;
        indexSetting.fs.exist({
            path: filepath
        }, function(retes, erres) {
          	if(!retes.exist) {
                //如果不存在就创建文件
                createBookFile(content);
            }else{
                // indexSetting.fs.remove({
                //     path: filepath
                // }, function(ret, err) {
                //     if (ret.status) {
                //         createBookFile(content);
                //     } else {
                //         alert(JSON.stringify(err));
                //     }
                // });
                //如果存在就打开文件
                openbook(filepath,progress);
            }
          }
        );
      }
    //创建文件
    function createBookFile(data){
      indexSetting.fs.createFile({
          path: vm.filepath
        }, function(ret, err) {
          if (ret.status) {
              openBookFile(data);
          }else{
              alert(JSON.stringify(err));
          }
        }
      )
    }
    //打开文件
    function openBookFile(data){
      indexSetting.fs.open({
          path: vm.filepath,
          flags: 'read_write'
        }, function(ret, err) {
          if (ret.status) {
            writeBookFile(ret,data);
          }else{
              alert(JSON.stringify(err));
          }
        }
      )
    }
    //写入文件
    function writeBookFile(ret,data){
      indexSetting.fs.write({
            fd: ret.fd,
            data:data
        }, function(ret, err) {
          if (ret.status) {
              openbook(vm.filepath,0);
          }else{
              alert(JSON.stringify(err));
          }
        }
      )
    }
    //打开阅读器
    function openbook(filepath,progress){
      //加载阅读器
      var config = {
          filePath: vm.filepath,
          codingType: "utf8",
          bg: indexSetting.bg,
          h: api.winHeight,
          y: 0,
          animType: '',
          progress:progress>0?progress:0,
          textStyle: {
              size: indexSetting.fontsize,
              color: indexSetting.color
          }
      };
      //给阅读器绑定事件
      indexSetting.bookReader.open(config, function(ret, err) {
          if (ret) {
              toast.hide();
              switch (ret.eventType) {
                  case 'click':
                      //点击打开设置
                      toggleset();
                      break;
                  case 'page_begin':
                      //上一章
                      toast.loading({
                          title:"loading...",
                          duration:2000
                      })
                      getPrev();
                      break;
                  case 'page_end':
                      //下一章
                      toast.loading({
                          title:"loading...",
                          duration:2000
                      })
                      getNext();
                      break;
                  default:
                      break;
              }
          } else {
              alert(JSON.stringify(err));
          }
      })
      // indexSetting.bookReader.getProgress({
      //     filePath: vm.filepath
      // }, function(ret, err) {
      //   if (ret.status) {
      //       alert(ret.progress);
      //   }
      // });
    }
    //打开阅读页设置
    function toggleset() {
        api.openFrame({
            name: 'readset',
            url: './readset.html',
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                h: api.winHeight
            },
            pageParam: {},
            bounces: false,
            reload: true,
            vScrollBarEnabled: false,
            hScrollBarEnabled: false,
            animation: {
                type: "none",
                subType: "from_right",
                duration: 300
            }
        });
    }

    // 上一章
    function getPrev() {
      var thebook = $api.getStorage('thebook');
      if(thebook.prevChapter == ""){
        alert("已经是第一页")
      }else{
        //请求数据
        vm.filepath = 'fs://' + thebook.book_id + '_' + thebook.prevChapter + '.txt';
        getData(thebook.book_id,thebook.prevChapter,100);
      }
    }

    // 下一章
    function getNext() {
      var thebook = $api.getStorage('thebook');
      if(thebook.nextChapter == ""){
        alert("已经最后一页")
      }else{
        //请求数据
        vm.filepath = 'fs://' + thebook.book_id + '_' + thebook.nextChapter + '.txt';
        getData(thebook.book_id,thebook.nextChapter,0);
      }
    }

    //阅读历史
    function ajaxhistory(chapterid,chapter_name,price) {
        var progress = 0;
        var thebook = $api.getStorage('thebook');
        indexSetting.bookReader.getProgress({
            filePath: 'fs://' + indexSetting.book_id + '_' + chapterid + '.txt'
        }, function(ret, err) {
            if (ret.status) {
                progress = ret.progress;
            }

            var history = $api.getStorage('history');
            if (history) {
                var isthebook = false;
                //判断历史记录里面有没有这本书的记录
                for (var i = 0, len = history.data.length; i < len; i++) {
                    //如果有  就更新这本书的历史记录
                    if (history.data[i].book_id == indexSetting.book_id) {
                        isthebook = true;
                        history.data[i].chapter_id = chapterid;//章节id
                        history.data[i].chapter_name = chapter_name;//章节名
                        history.data[i].progress = progress;//章节进度
                        history.data[i].price = price; //章节价格
                    }
                }
                $api.setStorage('history', history);
            }
            var newhistory = {};
            newhistory.id = thebook.id; //书的id
            newhistory.img = thebook.img; //书的图片
            newhistory.book_name = thebook.name; //书名
            newhistory.chapter_id = chapterid;  //章节id
            newhistory.chapter_name = chapter_name; //章节名称
            newhistory.progress = progress;  //章节进度
            newhistory.price = price;  //章节价格

            if(!history || isthebook === false) //如果没有历史记录 或者 没有这本书的历史记录
             {
               if(!history){
                 //如果没有历史记录  就新建历史记录
                 $api.setStorage('history', {
                   data: [newhistory]
                 });
               }else{
                 //如果有历史记录 但没有这本书的历史记录  就将这本书的历史记录添加进去
                 history.data.push(newhistory);
                 $api.setStorage('history', history);
               }
            }
        });
    }
  </script>
  </html>
